<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Move Price Adjustment - Just Move Vancouver</title>
    <style>
        :root {
            /* Just Move Vancouver Theme Colors */
            --primary-color: #001f3f;
            --secondary-color: #1e40af;
            --accent-color: #ea580c;
            --text-dark: #1f2937;
            --text-light: #6b7280;
            --background-light: #f9fafb;
            --background-dark: #ffffff;
            --border-color: #e5e7eb;
            --card-background: #f3f4f6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: var(--background-dark);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 700px;
            width: 100%;
            animation: slideUp 0.5s ease-out;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo {
            color: var(--primary-color);
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: var(--text-light);
            font-size: 16px;
            margin-bottom: 20px;
        }
        
        .move-info {
            background: var(--card-background);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid var(--border-color);
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .info-label {
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .info-value {
            color: var(--text-light);
        }
        
        .current-quote {
            background: var(--primary-color);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .current-price {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .current-hours {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .adjustment-section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .percentage-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .percentage-btn {
            background: var(--background-light);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 15px 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .percentage-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .percentage-btn.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(234, 88, 12, 0.3);
        }
        
        .percentage-btn.negative {
            background: #fef2f2;
            border-color: #fecaca;
            color: #dc2626;
        }
        
        .percentage-btn.negative.active {
            background: #dc2626;
            color: white;
            border-color: #dc2626;
        }
        
        .percentage-btn.positive {
            background: #f0fdf4;
            border-color: #bbf7d0;
            color: #16a34a;
        }
        
        .percentage-btn.positive.active {
            background: #16a34a;
            color: white;
            border-color: #16a34a;
        }
        
        .adjusted-quote {
            background: var(--secondary-color);
            color: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }
        
        .adjusted-price {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .adjusted-hours {
            font-size: 18px;
            opacity: 0.9;
            margin-bottom: 15px;
        }
        
        .price-difference {
            font-size: 16px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            display: inline-block;
        }
        
        .submit-section {
            text-align: center;
        }
        
        .submit-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 10px;
        }
        
        .submit-btn:hover {
            background: #c2410c;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(234, 88, 12, 0.3);
        }
        
        .submit-btn.secondary {
            background: var(--text-light);
        }
        
        .submit-btn.secondary:hover {
            background: var(--text-dark);
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 25px;
                margin: 10px;
            }
            
            .percentage-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .info-row {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">Just Move Vancouver</div>
            <div class="subtitle">Move Completion - Price Adjustment</div>
        </div>
        
        <div class="move-info">
            <div class="info-row">
                <span class="info-label">Customer:</span>
                <span class="info-value" id="customer-name">Loading...</span>
            </div>
            <div class="info-row">
                <span class="info-label">Quote Number:</span>
                <span class="info-value" id="quote-number">Loading...</span>
            </div>
            <div class="info-row">
                <span class="info-label">Move Date:</span>
                <span class="info-value" id="move-date">Loading...</span>
            </div>
        </div>
        
        <div class="current-quote">
            <div class="current-price" id="original-price">$0.00</div>
            <div class="current-hours" id="original-hours">0.00 hours</div>
            <div style="font-size: 14px; margin-top: 5px; opacity: 0.8;">Original Quote</div>
        </div>
        
        <div class="adjustment-section">
            <div class="section-title">Select Price Adjustment</div>
            
            <div class="percentage-grid">
                <div class="percentage-btn negative" data-percent="-20">-20%</div>
                <div class="percentage-btn negative" data-percent="-15">-15%</div>
                <div class="percentage-btn negative" data-percent="-10">-10%</div>
                <div class="percentage-btn negative" data-percent="-5">-5%</div>
                <div class="percentage-btn positive" data-percent="5">+5%</div>
                <div class="percentage-btn positive" data-percent="10">+10%</div>
                <div class="percentage-btn positive" data-percent="15">+15%</div>
                <div class="percentage-btn positive" data-percent="20">+20%</div>
            </div>
        </div>
        
        <div class="adjusted-quote" id="adjusted-display" style="display: none;">
            <div class="adjusted-price" id="new-price">$0.00</div>
            <div class="adjusted-hours" id="new-hours">0.00 hours</div>
            <div class="price-difference" id="price-difference">No change</div>
        </div>
        
        <div class="submit-section">
            <button class="submit-btn" id="apply-btn" style="display: none;" onclick="applyAdjustment()">Apply Adjustment</button>
            <button class="submit-btn secondary" onclick="keepOriginal()">Keep Original Price</button>
        </div>
    </div>

    <script>
        // Variables to store original values from URL
        let originalPrice = 0;
        let originalHours = 0;
        let currentAdjustment = 0;
        
        // Get all percentage buttons
        const percentageBtns = document.querySelectorAll('.percentage-btn');
        const adjustedDisplay = document.getElementById('adjusted-display');
        const applyBtn = document.getElementById('apply-btn');
        
        // Function to round to nearest 15 minutes (0.25 hours)
        function roundToNearestQuarterHour(hours) {
            // Multiply by 4 to convert to 15-min increments, round, then divide back
            const rounded = Math.round(hours * 4) / 4;
            // Ensure we return exactly 2 decimal places
            return Math.round(rounded * 100) / 100;
        }
        
        // Add click listeners to percentage buttons
        percentageBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                // Remove active class from all buttons
                percentageBtns.forEach(b => b.classList.remove('active'));
                
                // Add active class to clicked button
                this.classList.add('active');
                
                // Get percentage value
                const percent = parseInt(this.dataset.percent);
                currentAdjustment = percent;
                
                // Calculate new hours with percentage adjustment
                const hoursAdjustment = (originalHours * percent) / 100;
                const calculatedNewHours = originalHours + hoursAdjustment;
                
                console.log('Original hours:', originalHours);
                console.log('Calculated new hours before rounding:', calculatedNewHours);
                
                // Round to nearest 15 minutes (0.25 hours)
                const newHours = roundToNearestQuarterHour(calculatedNewHours);
                
                console.log('Rounded new hours:', newHours);
                console.log('Should be multiple of 0.25:', newHours % 0.25 === 0);
                
                // Calculate hourly rate and new price based on rounded hours
                const hourlyRate = originalPrice / originalHours;
                const newPrice = hourlyRate * newHours;
                
                console.log('Hourly rate:', hourlyRate);
                console.log('New price:', newPrice);
                
                // Calculate differences
                const hoursDifference = newHours - originalHours;
                const priceDifference = newPrice - originalPrice;
                
                // Update display
                document.getElementById('new-price').textContent = `${newPrice.toFixed(2)}`;
                document.getElementById('new-hours').textContent = `${newHours.toFixed(2)} hours`;
                
                // Show detailed price difference
                const hoursDiffText = hoursDifference >= 0 ? 
                    `+${hoursDifference.toFixed(2)} hours` : 
                    `${hoursDifference.toFixed(2)} hours`;
                
                const priceDiffText = priceDifference >= 0 ? 
                    `+${priceDifference.toFixed(2)} increase` : 
                    `-${Math.abs(priceDifference).toFixed(2)} decrease`;
                
                document.getElementById('price-difference').textContent = `${priceDiffText} (${hoursDiffText})`;
                
                // Store the rounded values for webhook submission
                window.adjustedPrice = newPrice;
                window.adjustedHours = newHours;
                
                // Show adjusted quote and apply button
                adjustedDisplay.style.display = 'block';
                applyBtn.style.display = 'inline-block';
                
                // Scroll to adjusted quote
                adjustedDisplay.scrollIntoView({ behavior: 'smooth', block: 'center' });
            });
        });
        
        function applyAdjustment() {
            // Use the stored rounded values
            const newPrice = window.adjustedPrice || originalPrice;
            const newHours = window.adjustedHours || originalHours;
            
            const priceDifference = newPrice - originalPrice;
            const hoursDifference = newHours - originalHours;
            
            // Prepare data for webhook - ensure proper rounding
            const webhookData = {
                airtable_id: window.airtableId || '',
                customer_name: document.getElementById('customer-name').textContent,
                quote_number: document.getElementById('quote-number').textContent,
                move_date: document.getElementById('move-date').textContent,
                original_price: Math.round(originalPrice * 100) / 100,
                original_hours: Math.round(originalHours * 100) / 100,
                adjustment_percentage: currentAdjustment,
                new_price: Math.round(newPrice * 100) / 100,
                new_hours: Math.round(newHours * 100) / 100,
                price_difference: Math.round(priceDifference * 100) / 100,
                hours_difference: Math.round(hoursDifference * 100) / 100,
                status: 'adjusted',
                timestamp: new Date().toISOString()
            };
            
            console.log('Sending webhook data:', webhookData); // Debug log
            sendToWebhook(webhookData);
        }
        
        function keepOriginal() {
            // Prepare data for webhook
            const webhookData = {
                airtable_id: window.airtableId || '',
                customer_name: document.getElementById('customer-name').textContent,
                quote_number: document.getElementById('quote-number').textContent,
                move_date: document.getElementById('move-date').textContent,
                original_price: originalPrice,
                original_hours: originalHours,
                adjustment_percentage: 0,
                new_price: originalPrice,
                new_hours: originalHours,
                price_difference: 0,
                hours_difference: 0,
                status: 'no_change',
                timestamp: new Date().toISOString()
            };
            
            sendToWebhook(webhookData);
        }
        
        function sendToWebhook(data) {
            // Your actual webhook URL
            const webhookUrl = 'https://n8n-movers-project-n8n.5gwahg.easypanel.host/webhook/f73c1753-3498-47c0-99a9-dceb4f594501';
            
            // Show loading state
            const submitBtn = document.getElementById('apply-btn');
            const keepBtn = document.querySelector('.submit-btn.secondary');
            const originalApplyText = submitBtn.textContent;
            const originalKeepText = keepBtn.textContent;
            
            submitBtn.textContent = 'Processing...';
            submitBtn.disabled = true;
            keepBtn.textContent = 'Processing...';
            keepBtn.disabled = true;
            
            fetch(webhookUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                console.log('Success:', result);
                alert('Price adjustment submitted successfully!');
                // Optionally redirect or close window
                // window.close();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error submitting adjustment. Please try again.');
            })
            .finally(() => {
                // Reset buttons
                submitBtn.textContent = originalApplyText;
                submitBtn.disabled = false;
                keepBtn.textContent = originalKeepText;
                keepBtn.disabled = false;
            });
        }
        
        // Function to populate form with dynamic data
        function populateFormData(customerName, quoteNumber, moveDate, price, hours, airtableId) {
            // Update global variables for calculations
            originalPrice = price;
            originalHours = hours;
            
            // Update display elements
            document.getElementById('customer-name').textContent = customerName;
            document.getElementById('quote-number').textContent = quoteNumber;
            document.getElementById('move-date').textContent = moveDate;
            document.getElementById('original-price').textContent = `$${price.toFixed(2)}`;
            document.getElementById('original-hours').textContent = `${hours.toFixed(2)} hours`;
            
            // Store airtable ID globally for webhook submission
            window.airtableId = airtableId;
        }
        
        // Load data from URL parameters
        function loadFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const customerName = urlParams.get('customer') || 'Unknown Customer';
            const quoteNumber = urlParams.get('quote') || 'N/A';
            const moveDate = urlParams.get('date') || 'N/A';
            const price = parseFloat(urlParams.get('price')) || 0;
            const hours = parseFloat(urlParams.get('hours')) || 0;
            const airtableId = urlParams.get('id') || '';
            
            populateFormData(customerName, quoteNumber, moveDate, price, hours, airtableId);
        }
        
        // Load data when page loads
        window.addEventListener('load', loadFromURL);
    </script>
</body>
</html>
